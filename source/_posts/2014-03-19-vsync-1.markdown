---
layout: post
title: "谈垂直同步"
date: 2014-03-19 01:13
comments: true
categories: 
---

<!-- more -->


##背景知识
谈垂直同步不得不先说一下计算机的CPU、GPU、显示器的协作关系。如下图所示
 {% img /images/vsync_1/1.jpg %}
 
这里值得一提的是：**视频控制器**。它有两个职责：

 1. 对帧缓存进行逐行扫描（频率和显示器刷新率相同）
 2. 数模转换，将信号输出给显示器。



###CRT
先看古老的CRT显示器。

CRT显示器内部的电子枪会从上到下一行一行的扫描，当电子枪扫完最后一行后，即完成了一帧的刷新，然后电子枪会重新回到第一行开始下一帧的扫描。完成一帧的刷新后，显示器会产生一个“垂直回扫”(VBlank)的信号。

显示器每秒钟更新画面的次数是显示器的刷新率。一般典型的刷新率的取值有：60、75、120等等。CRT显示器将一直按照这个速率刷新画面。甚至画面没有任何的改变。
###LCD
再看LCD显示器。

LCD显示器内也根本没有电子枪这种东西。LCD的基本原理是：当向液晶通电时，液晶体分子排列得井然有序，可以使光线容易通过；而不通电时，液晶分子排列混乱，阻止光线通过。通电与不通电就可以让液晶像闸门般地阻隔或让光线穿过。

理论上说，可以有一个精密的电路控制LCD显示器上每一个像素的明暗，达到让整个画面同时更新的效果。但是，要控制每个LCD像素点的亮暗的成本太高，所以LCD显示器也沿用了CRT显示器的刷新率的方法，一行一行的更新画面。

##没有垂直同步会发生什么
首先从绘制中的单缓冲说起。绘制的时候如果采用单缓冲会导致如下缺点：

 - 慢。假设屏幕分辨率为1280 x 1024。视频控制器每刷新一次屏幕需要访问的内存数量至少是：1280 x 1024次。假设每秒刷新屏幕60次，每访问一次内存需要控制在12.7ns，而典型的DRAM的一个周期是200ns，显然是有效率问题的。
 - 用户能够在屏幕看到每帧画面的局部变化的过程，即闪烁明显。

双缓冲(double buffer)解决了单缓冲的问题，但是也带来了新的问题：就是撕裂(tearing)现象。如下图所示：

{% img /images/vsync_1/2.jpg %}
  
撕裂现象的本质是：显示器显示的画面有半幅第n-1帧的画面以及半幅第n帧的画面。

出现撕裂现象的原因是：显卡和显示器是异步工作的，有可能出现显示器和显卡绘制不同步的情况：当视频控制器读取framebuffer控制显示器正在刷新一帧的画面的时候，此时显卡更改了framebuffer的内容，那么显示器将会显示出半幅n-1画面以及半幅n画面。




##垂直同步（VSync）的概念
前面说了，撕裂的原因是：显卡和显示器工作不同步，那解决的方案也很简单，让他们同步即可。简单的说就是：
GPU在得到显示器的垂直回扫信号之前不工作。当开启垂直同步以后，GPU在绘制3D图形前会等待垂直同步信号，当该信号到达时，显卡才开始绘制3D图形。

在D3D的实现中，垂直同步实际上并不只是GPU需要等待同步信号，而是present方法被阻塞了。OpenGL也有类似的机制。

看一下没有打开垂直同步之前，渲染可能是这样的：
{% img /images/vsync_1/3.jpg %} 

打开了垂直同步之后，变成这样：
{% img /images/vsync_1/4.jpg %} 

根据垂直同步的原理可以看到，垂直同步牺牲了时间换取了同步，这样的**好处**是：

 1. 缓解撕裂现象
 2. 画面变得流畅

**劣势**是：增加游戏输入的延迟。垂直同步牺牲了frametime，也就是说FPS最大为60，且一旦frametime大于1/60s，那么由于GPU需要和显示器同步，FPS将可能等于30或20或15…

##自适应垂直同步（Adaptive VSync）
在传统的垂直同步中，当frametime大于1/60s时，帧数一般会被机械的划分成60、30、20、15……巨大的帧数落差给人卡顿的感觉。

Nvidia推出了一种叫“自适应垂直同步” 的方法。该方法的大意是：由显卡自己决定是否开启或者关闭垂直同步。

例如：当frametime小于1/60s时，此时发生撕裂的概率较大，那么显卡和驱动会将垂直同步打开；当frametime大于1/60s时，此时发生撕裂的概率较小，显卡和驱动会自动将垂直同步关闭掉。

要使用该特性至少需要Geforece GTX 6xx系列的显卡，并且需要驱动支持

##G-Sync
Adaptive VSync在垂直同步的基础上，一定程度上减轻了垂直同步带来的掉帧严重的问题。但是依然没有能够解决输入延迟的问题。要解决这个问题，就必须要让GPU和显示器完全同步，即：GPU渲染的每一帧都在屏幕显示。

一直以来的方法都是让GPU去迎合显示器的刷新率，现在G-Sync的做法是恰恰相反：让显示器的刷新频率来根据GPU输出的帧率来调整。

G-Sync是目前已知的最好的解决画面卡顿、撕裂的方法。无论frametime是多少都能最大限度的保证流畅度。

G-SYNC系统需求：
显卡：GeForce GTX 650 Ti Boost及以上
显示器：安装有G-SYNC模块
驱动程序：GeForce 331.58或更新版
操作系统：Windows 7/8/8.1
