---
layout: post
title: "蛮荒时代的bug两只"
date: 2014-04-09 02:17
comments: true
categories: bug
---

----------


<!--more-->
##背景
来自炫1产品的一个需求：希望能在某个时刻，绘制时把人物皮肤部分剔掉，如下图所示：
 
 {% img/images/20140409/1.jpg %}
 
具体开发过程和细节就不必多言了，在此过程中遇到两个bug颇有点意思。
 
##Bug 1：ShaderModel的代沟
其实开发从方案制定到设计、到编码都还比较顺利，突然在编写测试用例的时候，发现这样一个问题：经过程序处理后的效果比原始效果变亮了，而且好像还带有高光。
 
 {% img/images/20140409/2.jpg %}
 
两个小时后，突然想到，是不是和浮点精度有关系。因为左边的原始效果用的是ShaderModel1.0，而右边用的是ShaderModel3.0。

于是，在Dx的SDK文档中找到这样一段话：

```
Pixel Shader InputsFor pixel shader versions ps_1_1 - ps_2_0, diffuse and specular colors are saturated (clamped) in the range 0 to 1 before use by the shader.
```

恰好，炫舞1的光照计算是在VS中计算的，通过Color传递给PS，于是我想了想，打开了PIX这个工具。拿PIX分别打开左边的和右边的PS进行调试，发现左边绘制时和右边绘制时传进来的Color完全一样。
 
 {% img/images/20140409/3.jpg %}

头昏脑涨之时，才想起，PIX的实现应该是基于CPU模拟，不一定能还原这种问题。我猜问题的原因就应该是：SM3.0下传入PS的Color大于1，导致变亮。为了验证想法，我临时修改了一下PS：
```
psout.Color.rgb=psin.C0.xyz-float3(1.0f,1.0f,1.0f);
psout.Color.a = 1;
return psout;
```

果然，效果立刻被验证了。
 
 {% img/images/20140409/4.jpg %}
 
##Bug 2：ATI上vs2_0和ps3_0
解决完bug1后的第二天，产品的人告诉我，有的机器上绘制的效果什么都没有。一片漆黑。于是赶紧应战，没有发现error，毫无头绪。

问题只出现在几台机器上，通过观察发现这几台机器都是ati显卡，win7，xp都有。我努力在大脑中搜寻有关ati的关键字，隐约记得几年前好像碰到过ati 的显卡上vs和ps使用的ShaderModel版本不一致会有问题。现在VertexShader使用的是2.0；PixShader使用的是3.0。

临时全部修改为3.0，再一看画面，分毫必现、丝丝入扣，美轮美奂。顿时间，能感受到《岳阳楼记》中那句：“心旷神怡，宠辱偕忘，把酒临风，其喜洋洋者矣”的心情。

##教训

 1. 如果使用SM3.0以下的ShaderModel，注意传给PS的Color语义的值不会超过1.0；但是SM3.0以及以上的ShaderModel会超过。
 2. 牢记PIX的实现是基于软件渲染的，当有兼容性问题的时候PIX基本帮不了你。
 3. ATI的显卡上，要保持VS和PS使用相同的ShaderModel版本。
